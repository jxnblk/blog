{"path":"blog/the-mystery-of-the-mustard-people","title":"The Mystery of the Mustard People","date":"2023-08-21T00:00:00.000Z","excerpt":"<p>One of the more perplexing bugs I encountered working on <a href=\"https://novanticagame.com\">Novantica</a> so far was when all the NPC extras in the game suddenly turned a greenish-yellow color.\nI had just swapped out URP materials for ones using a new shader, so I suspected that change made this happen,\nbut I didn't want to revert back to the old materials.\nTo add icing to the cake, this issue was only happening in builds, not in the editor.\nI started to dig in, but didn't realize it would take so long to track down.</p>\n","html":"<p>One of the more perplexing bugs I encountered working on <a href=\"https://novanticagame.com\">Novantica</a> so far was when all the NPC extras in the game suddenly turned a greenish-yellow color.\nI had just swapped out URP materials for ones using a new shader, so I suspected that change made this happen,\nbut I didn't want to revert back to the old materials.\nTo add icing to the cake, this issue was only happening in builds, not in the editor.\nI started to dig in, but didn't realize it would take so long to track down.</p>\n<!-- more -->\n<p><img src=\"https://jxnblk.com/images/mustard/pizza.jpg\" alt=\"Screenshot showing yellow colored NPCs\"></p>\n<p>At first, since I didn't know how to reproduce the issue in the editor,\nI tried swapping different materials and shaders on one of the character models to see if it was related to any prefabs used to spawn the extras.\nNo luck, the character was still yellow.\nAfter a bit of fruitless searching on the Unity forums,\nI tried moving the model to different scenes and sometimes the material worked and other times not.\nI also noticed that the NPCs that were loaded from additive scenes didn't suffer the same ailment, as seen in the screenshot above.\nThose scenes were <a href=\"https://docs.unity3d.com/2021.3/Documentation/Manual/com.unity.addressables.html\">Addressables</a>, so I started to suspect it was something related to how I'd set up shared materials across scenes with the Addressables system.</p>\n<figure>\n  <img src='https://jxnblk.com/images/mustard/addressables.png' alt='Screenshot of Unity Addressables editor options' />\n  <figcaption>\n    Changing this option to <em>Use Existing Build</em> made the issue reproducible in the editor\n  </figcaption>\n</figure>\n<p>I switched the Unity Addressables <em>Play Mode Script</em> option to <em>Use Existing Build</em> and was able to start reproducing the issue in the editor.\nIt felt like I was onto something.</p>\n<p><img src=\"https://jxnblk.com/images/mustard/hotel.jpg\" alt=\"\"></p>\n<p>The next thing I tried was adding all the game's materials and textures to a new Addressables group.\nThis seemed to fix the yellow people problem, but now the materials were missing from some of the additively loaded Addressable scenes.\nIf you're familiar with Unity, the magenta colored objects in the screenshot above mean that the materials are missing.\nI tried a few different ways of grouping the materials in Addressables, but still wasn't able to get everything working as expected.</p>\n<p>At this point, I went outside to take a walk and clear my head.\n<em>Why were the characters turning yellow?</em>\n<em>They should be rendering in magenta if the material was missing.</em>\n<em>The shader looked like it was supposed to but only the color was off...</em></p>\n<p>Then it dawned on me.\nWhen I got back to the computer, I swapped the texture on the character material to confirm my suspicion.\nThe material <em>was</em>, in fact, working, but the UV maps were wrong.\nBut why?</p>\n<figure>\n  <img src='https://jxnblk.com/images/mustard/character-texture.png' alt='The texture used to color the low poly character models' />\n  <figcaption>\n    The texture used to color the low poly character models.\n  </figcaption>\n</figure>\n<p>This time, I found some <a href=\"https://forum.unity.com/threads/warning-to-all-my-friends-beware-optimise-mesh-data.544735/\">useful hints</a> from the forums.\nIt turns out the default <em>Optimize Mesh Data</em> setting on the imported character models was causing the UV map to get lost somewhere along the way.\nAs you can see in the texture above, the UV map controls how the low poly models are colored.\nFor some reason, the UV map was only set for one of these colors.</p>\n<figure>\n  <img\n    src='https://jxnblk.com/images/mustard/optimize-mesh.png'\n    alt='Screenshot of the Optimize Mesh option for the imported model'\n  />\n  <figcaption>\n    The default setting for Optimize Mesh was the culprit all along\n  </figcaption>\n</figure>\n<p>After disabling this on all the imported FBX models, everything was rendering as expected again.\nCase closed.</p>\n<p>If you've run into similar issues with Unity, I hope this post was helpful,\nbut if you know of another or better way to avoid this issue, please let me know.</p>\n<p><em>Alternative titles considered for this post:</em></p>\n<ul>\n<li>What is up with all these wasabi people?</li>\n<li>Perplexed by the pea soup people</li>\n<li>The curious case of caper colored characters</li>\n</ul>\n","tags":["devlog","unity","materials","shaders"]}